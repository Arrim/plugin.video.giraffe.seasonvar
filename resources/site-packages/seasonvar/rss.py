# coding: utf-8
# vim:fenc=utf-8:sts=0:ts=4:sw=4:et:tw=80

#
# Copyright © 2016 gr4ph3 <giraffeoncode@gmail.com>
#
# Distributed under terms of the MIT license.
#
from __future__ import unicode_literals
from seasonvar.requester import Requester
from datetime import datetime
import time
import re


FEEDURL = 'http://seasonvar.ru/rss.php'


def items(date):
    requester = Requester()
    regexp = re.compile(
        r'<title><!\[CDATA\['
        '(.+?)(?:( \(\d+ сезон\))?, ([^\]]+?))'
        '\]\]><\/title>[^<]*?'
        '<link>([^<]+?)<\/link>[^<]*?'
        '<pubDate>([^<]+?)<\/pubDate>',
        re.DOTALL)
    xml = requester.get(FEEDURL)
    for (name, s, e, url, datestr) in regexp.findall(xml):
        dt = datetime(*(time.strptime(datestr[:-6],
                      '%a, %d %b %Y %H:%M:%S')[0:6]))
        datestr = dt.strftime('%d.%m.%Y')
        if datestr == date:
            yield {
                'name': name.strip(),
                'changes': '{0} {1}'.format(s.strip(), e.strip()).strip(),
                'url': requester.relurl(url),
            }
