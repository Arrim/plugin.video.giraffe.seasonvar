# coding: utf-8

#
# Copyright Â© 2017 weirdgiraffe <giraffe@cyberzoo.xyz>
#
# Distributed under terms of the MIT license.
#
from __future__ import unicode_literals
import re
from seasonvar import SeasonvarRequester
try:
    from urllib.parse import urlparse
except ImportError:
    from urlparse import urlparse


def _absurl(url):
    o = urlparse(url)
    return 'http://seasonvar.ru' + o.path


class Season:
    def __init__(self, url, html=None, requester=SeasonvarRequester()):
        self.__requester = requester
        self.url = _absurl(url)
        self.thumb = self._thumb_url(self.url)
        if html is None:
            self.html = requester.get(self.url)
        else:
            self.html = html
        self.playlists = self._playlists()

    @property
    def episodes(self, translation=None):
        url = self._playlist4translation(translation)
        if url is None:
            url = self.playlists[0]['playlist_url']
        playlist_url = _absurl(url)
        playlist = self.__requester.get_json(playlist_url)
        return list(self._playlist_entries(playlist))

    def _playlist_entries(self, playlist_dict):
        playlist = playlist_dict['playlist']
        for entry in playlist:
            if 'playlist' in entry:
                for episode in entry['playlist']:
                    yield {'url': episode['file'],
                           'name': episode['comment'].replace('<br>', ' '),
                           'thumb': self.thumb}
            else:
                yield {'url': entry['file'],
                       'name': entry['comment'].replace('<br>', ' '),
                       'thumb': self.thumb}

    def _playlist4translation(self, translation):
        for t in self.playlists:
            if t['translation'] == translation:
                return t['playlist_url']
        return None

    def _playlists(self):
        tb = self._translations_block(self.html)
        return [x for x in self._translations(tb)]

    @staticmethod
    def _translations(htmlblock):
        r = re.compile(
            r'<li\s+id="translate.*?>(.*?)</li>.*?'
            r'var\s+pl\d+\s+=\s+"(.*?)";',
            re.DOTALL)
        for name, url in r.findall(htmlblock):
            yield {'translation': name.strip(), 'playlist_url': url.strip()}

    @staticmethod
    def _translations_block(html):
        r = re.compile(r'<ul\s+id="translateDiv"(.*?)</ul>', re.DOTALL)
        for b in r.findall(html):
            return b

    @staticmethod
    def _thumb_url(url):
        r = re.compile(r'^(?:http://.*?)(/serial-(\d+)-(?:.+?)'
                       r'(?:-(\d+)-(?:sezon|season))?\.html)$')
        for sid in r.findall(url):
            return 'http://cdn.seasonvar.ru/oblojka/{0}.jpg'.format(sid)
