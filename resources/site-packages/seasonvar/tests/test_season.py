# coding: utf-8

#
# Copyright Â© 2017 weirdgiraffe <giraffe@cyberzoo.xyz>
#
# Distributed under terms of the MIT license.
#
from __future__ import unicode_literals
import codecs
import os
import pytest
import re
import requests
from seasonvar.season import Season


def assetpath(path):
    return os.path.join(os.path.dirname(__file__), 'assets', path)


@pytest.mark.parametrize('url,asset', [
    ('/serial-13945-Horoshee_mesto.html',
     'serial-13945-Horoshee_mesto.html'),
])
def test_initialisation(url, asset):
    with codecs.open(assetpath(asset), 'r', 'utf-8') as f:
        s = Season(url=url, html=f.read())
        assert re.match(r'http://[a-z-A-z0-9\/\.]+.jpg', s.thumb)
        assert len(s.playlists) > 0


@pytest.mark.parametrize('asset, expected', [
    ('serial-13945-Horoshee_mesto.html', 1),
    ('serial-15031-Sdelano_iz_vtorsyr_ya.html', 0),
])
def test_translations_block_extraction(asset, expected):
    with codecs.open(assetpath(asset), 'r', 'utf-8') as f:
        html = f.read()
        block_exists = Season._translations_block(html) is not None
        assert block_exists == expected


@pytest.mark.parametrize('asset, expected_count', [
    ('translations_block_one_entry.html', 1),
    ('translations_block_multiple_entries.html', 2),
    ('serial-15031-Sdelano_iz_vtorsyr_ya.html', 1),
])
def test_playlists_extraction(asset, expected_count):
    with codecs.open(assetpath(asset), 'r', 'utf-8') as f:
        s = Season(url=asset, html=f.read())
        playlists = [x for x in s._find_playlists()]
        assert len(playlists) == expected_count
        for t in playlists:
            assert len(t['translation']) != 0
            assert re.match(r'/playls.*/list.xml\?time=\d+', t['playlist_url'])


@pytest.mark.online
def test_online_translations_extraction():
    s = Season('http://seasonvar.ru/serial-13945-Horoshee_mesto.html')
    assert len(s.playlists) > 0
    for t in s.playlists:
        assert len(t['translation']) != 0
        assert re.match(r'/playls.*/list.xml\?time=\d+', t['playlist_url'])


@pytest.mark.localonly
@pytest.mark.online
def test_online_episodes():
    s = Season('http://seasonvar.ru/serial-13945-Horoshee_mesto.html')
    episodes = s.episodes()
    assert len(episodes) > 0
    for e in episodes:
        assert re.match(r'.*\.(m3u8|mp4)$', e['url'])
        assert len(e['name']) != 0
        assert e['thumb'] == s.thumb
        res = requests.head(e['url'])
        assert res.status_code == 200
