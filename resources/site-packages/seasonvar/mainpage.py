# coding: utf-8

#
# Copyright Â© 2017 weirdgiraffe <giraffe@cyberzoo.xyz>
#
# Distributed under terms of the MIT license.
#
from __future__ import unicode_literals
from seasonvar import Requester
import re


def page_dayblocks(full_page_html):
    '''Collect all dayblocks from full_page_html
    and yield (date, content) for every dayblock'''
    r = re.compile(
        r'<div class="ff1">(\d{2}\.\d{2}\.\d{4})(.*?)'
        r'(?=<div align="center"|<div class="film-list-block")',
        re.DOTALL)
    for group in r.findall(full_page_html):
        d, c = group
        yield group


def dayblock_items(dayblock_content):
    '''Collect all series items from dayblock_content
    and for every item yield dict with description'''
    r = re.compile(
        r'<a href="(\/serial-.+?\.html)" class="film-list-item-link">'
        '(.+?)<\/a>(.*?)<span>(.+?)<\/span>',
        re.DOTALL)
    for (url, name, changes1, changes2) in r.findall(dayblock_content):
        changes = '{0} {1}'.format(changes1.strip(), changes2.strip())
        yield {'url': url,
               'name': name.strip(),
               'changes': changes.strip()}


def dayitems(datestr):
    '''Collect all dayblock items(i.e series) for a given date'''
    requester = Requester()
    html = requester.get('http://seasonvar.ru')
    for (date, dayblock) in page_dayblocks(html):
        if datestr == date:
            # in python > 3.3.0 it is just:
            #
            #   yield from dayblock_items(dayblock)
            #
            # but kodi use old python
            for item in dayblock_items(dayblock):
                yield item
